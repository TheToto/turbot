dist: xenial
language: python
python:
- '3.7'
services:
- docker
before_install:
- pip install pipenv
install:
- pipenv sync
stages:
- black
- test
- build
- deploy
before_script:
- if [ $TRAVIS_PULL_REQUEST == "false" ]; then export TAG=latest; else export TAG="pr-$TRAVIS_PULL_REQUEST_BRANCH";
  fi
jobs:
  include:
  - stage: black
    install: pip install black
    script: black --check .
  - stage: test
    install:
    - pipenv sync --dev
    - pip install coveralls
    script:
    - pytest
    after_success:
    - coveralls
  - stage: build
    script:
    - docker build -t $DOCKER_REGISTRY:$TAG .
  - stage: deploy
    script:
    - docker build -t $DOCKER_REGISTRY:$TAG .
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push $DOCKER_REGISTRY:$TAG;
    if: tag IS present
    on:
      tags: true
    deploy:
      provider: heroku
      app: "$HEROKU_APP"
      api_key: "$HEROKU_AUTH_KEY"
  - stage: deploy
    script:
    - docker build -t $DOCKER_REGISTRY:$TAG .
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push $DOCKER_REGISTRY:$TAG;
    if: branch= master
    deploy:
      provider: heroku
      app: "$HEROKU_APP_STAGING"
      api_key: "$HEROKU_AUTH_KEY"
branches:
  only:
  - master
  - "/^v.*$/"
notifications:
  slack:
    on_success: always
    on_failure: always
    rooms:
      secure: s2ZVI+zW9Wob5Uzceuj0ZGYXwqZViD83RYLO9VK23B6X2+mEyRy0bdT6PEy55+bOdAwL8Thp2djud6/r6pSr0wovI5JsoxcmFIK5LIitkTY5I7UHE6EYgSvxsJry+a4s10kJ9zddB78cX57rkl6ESyN6j6RZW740MVpFdyW92FK6ALq9HSq8BTPEzmFuCm39o3h++uZz/3/EbxpA0Hj8txRZzgmhPagdxUqDm3o3NgEWpkF2qNaJ6AndCKAcB8HLxhXRR8FdzaPIyXKguf/2tHDYuz4G8b8GLHXp9naPbcKZq7Y4nEU/UW+CxZrJdguccYjw79Wq0yHe6Gib9bcW7xtKU6USeCHL8/aQwZOlZzAnlt0zmMzrOIfYtPKEHbEk5gyMZ6ilkGllX3E9n3Z+p4nW1/4wsWncsCW+HRZSs02ecG0gmR3/CIIky/VVXtmoenuT5pWr87I5K9EUI04BJRhu5uX54p7OmAPwRngu6aMz/IhsJJYPEhnr1Zf6vD9CVH5KOYz1/3Zcg+XCJTOIRKOPWDJsOuzkloKR44I+wLa34DgX6XALL1MtgwSFk92VCWg8SKrhRYABkVHdb820dAAAQELHlgRZPn7Dws/DCaTGPketmgKPW2lf8zjZqbjJ7V+6Yw5I7UjphAa6n9/GnjRPnN2dajlDVLl3fuThycc=
